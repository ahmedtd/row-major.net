# Note: Because of how Gitlab CI constructs the DAG, it's important that a job
# is only defined if all of the jobs it depends on is defined.  In practice,
# this means that the `rules` of a job needs to be a superset of the `rules` of
# all of its dependencies.

variables:
  BAZEL_VERSION: "5.1.0"

stages:
  - test
  - upload-images
  - update-manifest
  - deploy

test-everything:
  stage: test
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - when: on_success
  needs: []
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "curl -L https://releases.bazel.build/${BAZEL_VERSION}/release/bazel-${BAZEL_VERSION}-linux-x86_64 > bazel"
    - "chmod +x bazel"
    - "./bazel test -- //..."

sharded-controller/upload-images:
  stage: upload-images
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - changes:
        - shardedcontroller/*
      when: on_success
  needs: ["test-everything"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud auth configure-docker gcr.io"
    - "curl -L https://releases.bazel.build/${BAZEL_VERSION}/release/bazel-${BAZEL_VERSION}-linux-x86_64 > bazel"
    - "chmod +x bazel"
    - "GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_KEY_FILE} IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazel run //shardedcontroller:push"

rumor-mill/upload-images:
  stage: upload-images
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - changes:
        - rumor-mill/*
      when: on_success
  needs: ["test-everything"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud auth configure-docker gcr.io"
    - "curl -L https://releases.bazel.build/${BAZEL_VERSION}/release/bazel-${BAZEL_VERSION}-linux-x86_64 > bazel"
    - "chmod +x bazel"
    - "GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_KEY_FILE} IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazel run //rumor-mill:rumor-mill_push"

row-major-web/upload-images:
  stage: upload-images
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - changes:
        - webalator/*
      when: on_success
  needs: ["test-everything"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud auth configure-docker gcr.io"
    - "curl -L https://releases.bazel.build/${BAZEL_VERSION}/release/bazel-${BAZEL_VERSION}-linux-x86_64 > bazel"
    - "chmod +x bazel"
    - "GOOGLE_APPLICATION_CREDENTIALS=${GCP_SA_KEY_FILE} IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazel run //webalator:webalator_push"

row-major-web/update-manifest:
  stage: update-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPDATE_IMAGES_IN_MANIFEST=/m"
      when: never
    - changes:
        - webalator/*
      when: on_success
  needs: ["row-major-web/upload-images"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - |
      cat <<EOF >manifests/production/row-major-web-production-images.patch.yaml
      # This file is overwritten by CI
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: row-major-web-content-deployment
        namespace: row-major-web
      spec:
        template:
          spec:
            containers:
              - name: row-major-web-content
                image: gcr.io/bomsync-214520/webalator:${CI_COMMIT_SHA}
      EOF
    - |
      cat <<EOF >commit-message.txt
      Manifest update for row-major-web @ ${CI_COMMIT_SHA}

      NO_TEST=
      NO_UPLOAD_IMAGES=
      NO_UPDATE_IMAGES_IN_MANIFEST=
      EOF
    - kubectl kustomize manifests/production > manifests/production/rendered.yaml
    - |
      curl \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        --form "branch=master" \
        --form "commit_message=<commit-message.txt" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/row-major-web-production-images.patch.yaml" \
        --form "actions[][content]=<manifests/production/row-major-web-production-images.patch.yaml" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/rendered.yaml" \
        --form "actions[][content]=<manifests/production/rendered.yaml" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/commits"

rumor-mill/update-manifest:
  stage: update-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPDATE_IMAGES_IN_MANIFEST=/m"
      when: never
    - changes:
        - rumor-mill/*
      when: on_success
  needs: ["rumor-mill/upload-images"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - |
      cat <<EOF >manifests/production/row-major-web-production-images.patch.yaml
      # This file is overwritten by CI
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: rumor-mill
        namespace: rumor-mill
      spec:
        template:
          spec:
            containers:
            - name: main
              image: gcr.io/bomsync-214520/rumor-mill:${CI_COMMIT_SHA}
      EOF
    - |
      cat <<EOF >commit-message.txt
      Manifest update for rumor-mill @ ${CI_COMMIT_SHA}

      NO_TEST=
      NO_UPLOAD_IMAGES=
      NO_UPDATE_IMAGES_IN_MANIFEST=
      EOF
    - kubectl kustomize manifests/production > manifests/production/rendered.yaml
    - |
      curl \
        --fail \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        --form "branch=master" \
        --form "commit_message=<commit-message.txt" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/rumor-mill-production-images.patch.yaml" \
        --form "actions[][content]=<manifests/production/rumor-mill-production-images.patch.yaml" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/rendered.yaml" \
        --form "actions[][content]=<manifests/production/rendered.yaml" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/commits"

sharded-controller/update-manifest:
  stage: update-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_TEST=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPLOAD_IMAGES=/m"
      when: never
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_UPDATE_IMAGES_IN_MANIFEST=/m"
      when: never
    - changes:
        - shardedcontroller/*
      when: on_success
  needs: ["sharded-controller/upload-images"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - |
      cat <<EOF >manifests/production/row-major-web-production-images.patch.yaml
      # This file is overwritten by CI
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: sharded-controller
        namespace: sharded-controller
      spec:
        template:
          spec:
            containers:
              - name: sharded-controller
                image: gcr.io/bomsync-214520/shardedcontroller:${CI_COMMIT_SHA}
      EOF
    - |
      cat <<EOF >commit-message.txt
      Manifest update for sharded-controller @ ${CI_COMMIT_SHA}

      NO_TEST=
      NO_UPLOAD_IMAGES=
      NO_UPDATE_IMAGES_IN_MANIFEST=
      EOF
    - kubectl kustomize manifests/production > manifests/production/rendered.yaml
    - |
      curl \
        --fail \
        --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_API_TOKEN}" \
        --form "branch=master" \
        --form "commit_message=<commit-message.txt" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/sharded-controller-production-images.patch.yaml" \
        --form "actions[][content]=<manifests/production/sharded-controller-production-images.patch.yaml" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/rendered.yaml" \
        --form "actions[][content]=<manifests/production/rendered.yaml" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/commits"
        
deploy-manifest:
  stage: deploy
  environment:
    name: production
    url: https://row-major.net/
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^NO_APPLY_MANIFEST=/m"
      when: never
    - changes:
        - manifests/*
      when: on_success
  needs: []
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud container clusters get-credentials --project=bomsync-214520 --zone=us-west1-a taahm-primary-cluster"
    - "kubectl apply -f manifests/production/rendered.yaml"
