stages:
  - upload-images
  - update-manifest
  - apply-manifest

Upload Images:
  stage: upload-images
  rules:
    - if: "$CI_COMMIT_MESSAGE !~ /^NO_UPLOAD_IMAGES=/m"
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud --project=bomsync-214520 builds submit ./ --config=cloudbuild.yaml --timeout=10m --substitutions=COMMIT_SHA=${CI_COMMIT_SHA}"

Update Manifest:
  stage: update-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE !~ /^NO_UPDATE_IMAGES_IN_MANIFEST=/m"
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - |
      cat <<EOF >manifests/production/production-images.patch.yaml
      # This file is overwritten by CI
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: row-major-web-content-deployment
        namespace: row-major-web
      spec:
        template:
          spec:
            containers:
              - name: row-major-web-content
                image: gcr.io/bomsync-214520/webalator:${CI_COMMIT_SHA}
      EOF
    - |
      cat <<EOF >commit-message.txt
      Manifest update for ${CI_COMMIT_SHA}

      NO_UPLOAD_IMAGES=
      NO_UPDATE_IMAGES_IN_MANIFEST=
      EOF
    - kubectl kustomize manifests/production > manifests/production/rendered.yaml
    - |
      curl \
        --request POST \
        --header "PRIVATE-TOKEN:${GITLAB_API_TOKEN}" \
        --form "branch=master" \
        --form "commit_message=<commit-message.txt" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/production-images.patch.yaml" \
        --form "actions[][content]=<manifests/production/production-images.patch.yaml" \
        --form "actions[][action]=create" \
        --form "actions[][file_path]=manifests/production/rendered.yaml" \
        --form "actions[][content]=<manifests/production/rendered.yaml" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/commits"

Apply Manifest:
  stage: apply-manifest
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud --project=bomsync-214520 builds submit ./ --config=cloudbuild-deploy.yaml --timeout=10m --substitutions=COMMIT_SHA=${CI_COMMIT_SHA}"

