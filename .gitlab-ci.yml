stages:
  - test
  - upload-images
  - update-manifest
  - apply-manifest

Test Everything:
  stage: test
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.11.0/bazelisk-linux-amd64 > bazelisk"
    - "chmod +x bazelisk"
    - "./bazelisk test //..."

Upload Images:
  stage: upload-images
  rules:
    - if: "$CI_COMMIT_MESSAGE !~ /^NO_UPLOAD_IMAGES=/m"
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "curl -L https://github.com/bazelbuild/bazelisk/releases/download/v1.11.0/bazelisk-linux-amd64 > bazelisk"
    - "chmod +x bazelisk"
    - "IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazelisk run //webalator:webalator_push"
    - "IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazelisk run //shardedcontroller:push"
    - "IMAGE_REPO=bomsync-214520 IMAGE_TAG=${CI_COMMIT_SHA} ./bazelisk run //rumor-mill:rumor-mill_push"

Update Manifest:
  stage: update-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE !~ /^NO_UPDATE_IMAGES_IN_MANIFEST=/m"
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - |
      cat <<EOF >manifests/production/production-images.patch.yaml
      # This file is overwritten by CI
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: row-major-web-content-deployment
        namespace: row-major-web
      spec:
        template:
          spec:
            containers:
              - name: row-major-web-content
                image: gcr.io/bomsync-214520/webalator:${CI_COMMIT_SHA}
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: sharded-controller
        namespace: sharded-controller
      spec:
        template:
          spec:
            containers:
              - name: sharded-controller
                image: gcr.io/bomsync-214520/shardedcontroller:${CI_COMMIT_SHA}
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: rumor-mill
        namespace: rumor-mill
      spec:
        template:
          spec:
            containers:
            - name: main
              image: gcr.io/bomsync-214520/rumor-mill:${CI_COMMIT_SHA}
      EOF
    - |
      cat <<EOF >commit-message.txt
      Manifest update for ${CI_COMMIT_SHA}

      NO_UPLOAD_IMAGES=
      NO_UPDATE_IMAGES_IN_MANIFEST=
      APPLY_MANIFEST=
      EOF
    - kubectl kustomize manifests/production > manifests/production/rendered.yaml
    - |
      curl \
        --request POST \
        --header "PRIVATE-TOKEN:${GITLAB_API_TOKEN}" \
        --form "branch=master" \
        --form "commit_message=<commit-message.txt" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/production-images.patch.yaml" \
        --form "actions[][content]=<manifests/production/production-images.patch.yaml" \
        --form "actions[][action]=update" \
        --form "actions[][file_path]=manifests/production/rendered.yaml" \
        --form "actions[][content]=<manifests/production/rendered.yaml" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/repository/commits"

Apply Manifest:
  stage: apply-manifest
  rules:
    - if: "$CI_COMMIT_MESSAGE =~ /^APPLY_MANIFEST=/m"
  image: gcr.io/google.com/cloudsdktool/cloud-sdk
  script:
    - "gcloud auth activate-service-account --key-file=${GCP_SA_KEY_FILE}"
    - "gcloud container clusters get-credentials --project=bomsync-214520 --zone=us-west1-a taahm-primary-cluster"
    - "kubectl apply -f manifests/production/rendered.yaml"
